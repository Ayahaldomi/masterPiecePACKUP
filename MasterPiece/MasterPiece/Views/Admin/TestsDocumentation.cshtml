@model IEnumerable<MasterPiece.Models.Test>

@{
    ViewBag.Title = "TestsDocumentation";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<style>
    .container {
        width: 80%;
        margin: 0 auto;
        padding: 20px;
    }

    h1 {
        text-align: center;
    }

    #searchBar {
        margin-bottom: 20px;
    }

    .card {
        padding: 1em;
    }

    button.btn.btn-success {
        margin: 0.5em;
    }

    body {
        background-color: #69acc759;
    }

    .container-fluid {
        padding-top: 120px !important;
    }
</style>

<div class="card">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Test Documentation</h1>
        <div class="mb-3">
            <input type="text" id="searchBar" class="form-control" onkeyup="filterByTestName()" placeholder="Search for tests by name...">
        </div>
        <div class="mb-3">
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#testFormModal">
                Add New Test
            </button>
        </div>
        <table class="table table-striped table-bordered" id="testTable">
            <thead class="table-light">
                <tr>
                    <th>Test ID</th>
                    <th>Test Name</th>
                    <th>Description</th>
                    <th>Normal Range</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var test in Model)
                {
                    <tr>
                        <td>@test.Test_ID</td>
                        <td>@test.Test_Name</td>
                        <td>@test.Description</td>
                        <td>@test.Normal_Range</td>
                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-outline-warning me-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editTestModal"
                                    onclick="populateEditModal('@test.Test_ID', '@test.Test_Name', '@test.Description', '@test.Normal_Range', '@test.Price', '@test.Inventory', '@test.Components', '@test.Unit', '@test.Sample_Type', '@test.Expiration_Date')">
                                Edit
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteTestModal"
                                    onclick="setDeleteTest('@test.Test_ID', '@test.Test_Name')">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <!-- Centered Pagination controls -->
        <div id="pagination" class="text-center">
            <button class="btn btn-outline-primary" onclick="previousPage()">Previous</button>
            <span id="pageNumber" class="mx-2"></span>
            <button class="btn btn-outline-primary" onclick="nextPage()">Next</button>
        </div>
    </div>
</div>

<!-- Add New Test Modal -->
<div class="modal fade" id="testFormModal" tabindex="-1" aria-labelledby="testFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testFormModalLabel">New Test Form</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            @using (Html.BeginForm("CreateTest", "Admin", FormMethod.Post))
            {
                <div class="modal-body">

                    @Html.AntiForgeryToken()
                    <div class="form-horizontal">

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Test Name</label>
                                <div class="col-md-8">
                                    <input type="text" name="Test_Name" class="form-control" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="control-label col-md-4">Alternative Name</label>
                                <div class="col-md-8">
                                    <input type="text" name="Alternative_Name" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Components</label>
                                <div class="col-md-8">
                                    <input type="text" name="Components" class="form-control" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="control-label col-md-4">Normal Range</label>
                                <div class="col-md-8">
                                    <input type="text" name="Normal_Range" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Unit</label>
                                <div class="col-md-8">
                                    <input type="text" name="Unit" class="form-control" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="control-label col-md-4">Description</label>
                                <div class="col-md-8">
                                    <input type="text" name="Description" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Price</label>
                                <div class="col-md-8">
                                    <input type="number" name="Price" class="form-control" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="control-label col-md-4">Inventory</label>
                                <div class="col-md-8">
                                    <input type="number" name="Inventory" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Sample Type</label>
                                <div class="col-md-8">
                                    <input type="text" name="Sample_Type" class="form-control" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="control-label col-md-4">Expiration Date</label>
                                <div class="col-md-8">
                                    <input type="date" name="Expiration_Date" class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Edit Test Modal -->
<div class="modal fade" id="editTestModal" tabindex="-1" aria-labelledby="editTestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTestModalLabel">Edit Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            @using (Html.BeginForm("EditTest", "Admin", FormMethod.Post))
            {
                <div class="modal-body">

                    @Html.AntiForgeryToken()
                    <div class="form-horizontal">
                        <!-- Hidden field for Test ID -->
                        <input type="hidden" name="Test_ID" id="editTestId" />

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Test Name</label>
                                <div class="col-md-8">
                                    <input type="text" name="Test_Name" id="editTestName" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Alternative Name</label>
                                <div class="col-md-8">
                                    <input type="text" name="Alternative_Name" id="editAlternativeName" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Components</label>
                                <div class="col-md-8">
                                    <input type="text" name="Components" id="editComponents" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Normal Range</label>
                                <div class="col-md-8">
                                    <input type="text" name="Normal_Range" id="editNormalRange" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Unit</label>
                                <div class="col-md-8">
                                    <input type="text" name="Unit" id="editUnit" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Description</label>
                                <div class="col-md-8">
                                    <input type="text" name="Description" id="editDescription" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Price</label>
                                <div class="col-md-8">
                                    <input type="number" name="Price" id="editPrice" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Inventory</label>
                                <div class="col-md-8">
                                    <input type="number" name="Inventory" id="editInventory" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Sample Type</label>
                                <div class="col-md-8">
                                    <input type="text" name="Sample_Type" id="editSampleType" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="control-label col-md-4">Expiration Date</label>
                                <div class="col-md-8">
                                    <input type="date" name="Expiration_Date" id="editExpirationDate" class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            }
            </div>
    </div>
</div>

<!-- Delete Test Confirmation Modal -->
<div class="modal fade" id="deleteTestModal" tabindex="-1" aria-labelledby="deleteTestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTestModalLabel">Delete Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <strong id="deleteTestName"></strong>?
            </div>
            <div class="modal-footer">
                @using (Html.BeginForm("DeleteTest", "Admin", FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="Test_ID" id="deleteTestId" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                }
            </div>
        </div>
    </div>
</div>

<script>
    // Function to populate the Edit Modal with test data
    function populateEditModal(testId, testName, description, normalRange, price, inventory, components, unit, sampleType, expirationDate) {
        document.getElementById("editTestId").value = testId;
        document.getElementById("editTestName").value = testName;
        document.getElementById("editAlternativeName").value = components;
        document.getElementById("editNormalRange").value = normalRange;
        document.getElementById("editPrice").value = price;
        document.getElementById("editInventory").value = inventory;
        document.getElementById("editComponents").value = components;
        document.getElementById("editUnit").value = unit;
        document.getElementById("editDescription").value = description;
        document.getElementById("editSampleType").value = sampleType;

        // Format the expiration date to 'YYYY-MM-DD' before setting the value
        if (expirationDate) {
            // Convert the date to YYYY-MM-DD format if it's not empty or null
            var formattedDate = new Date(expirationDate).toISOString().split('T')[0];
            document.getElementById("editExpirationDate").value = formattedDate;
        } else {
            // Clear the field if no date is provided
            document.getElementById("editExpirationDate").value = '';
        }
    }


    function setDeleteTest(testId, testName) {
        // Set the hidden input field in the delete modal to the test ID
        document.getElementById("deleteTestId").value = testId;

        // Update the delete confirmation message with the test name
        document.getElementById("deleteTestName").innerText = testName;
    }
</script>
<script>
    // Pagination setup
    var currentPage = 1;
    var rowsPerPage = 4; // Set the number of rows to display per page

    function displayTableRows(page) {
        var table = document.getElementById("testTable");
        var rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
        var totalRows = rows.length;
        var totalPages = Math.ceil(totalRows / rowsPerPage);

        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;

        currentPage = page;

        // Hide all rows first
        for (var i = 0; i < totalRows; i++) {
            rows[i].style.display = "none";
        }

        // Show rows for the current page
        var start = (page - 1) * rowsPerPage;
        var end = start + rowsPerPage;
        for (var i = start; i < end && i < totalRows; i++) {
            rows[i].style.display = "";
        }

        // Update page number display
        document.getElementById("pageNumber").innerText = "Page " + currentPage + " of " + totalPages;
    }

    function previousPage() {
        if (currentPage > 1) {
            displayTableRows(currentPage - 1);
        }
    }

    function nextPage() {
        var table = document.getElementById("testTable");
        var rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
        var totalPages = Math.ceil(rows.length / rowsPerPage);
        if (currentPage < totalPages) {
            displayTableRows(currentPage + 1);
        }
    }

    // Initialize pagination on page load
    window.onload = function () {
        displayTableRows(currentPage);
    };

    // Filter by test name
    function filterByTestName() {
        var input = document.getElementById("searchBar");
        var filter = input.value.toLowerCase();
        var table = document.getElementById("testTable");
        var rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

        for (var i = 0; i < rows.length; i++) {
            var testNameCell = rows[i].getElementsByTagName("td")[1]; // The second cell is Test Name
            var testName = testNameCell.textContent || testNameCell.innerText;
            if (testName.toLowerCase().indexOf(filter) > -1) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }
</script>